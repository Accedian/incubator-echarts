
/*
* Licensed to the Apache Software Foundation (ASF) under one
* or more contributor license agreements.  See the NOTICE file
* distributed with this work for additional information
* regarding copyright ownership.  The ASF licenses this file
* to you under the Apache License, Version 2.0 (the
* "License"); you may not use this file except in compliance
* with the License.  You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing,
* software distributed under the License is distributed on an
* "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
* KIND, either express or implied.  See the License for the
* specific language governing permissions and limitations
* under the License.
*/


!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("echarts")):"function"==typeof define&&define.amd?define(["exports","echarts"],e):e((t=t||self).bmap={},t.echarts)}(this,(function(t,e){"use strict";function o(t,e){this._bmap=t,this.dimensions=["lng","lat"],this._mapOffset=[0,0],this._api=e,this._projection=new BMap.MercatorProjection}function n(t,o){return o=o||[0,0],e.util.map([0,1],(function(e){var n=o[e],r=t[e]/2,i=[],a=[];return i[e]=n-r,a[e]=n+r,i[1-e]=a[1-e]=o[1-e],Math.abs(this.dataToPoint(i)[e]-this.dataToPoint(a)[e])}),this)}var r;o.prototype.dimensions=["lng","lat"],o.prototype.setZoom=function(t){this._zoom=t},o.prototype.setCenter=function(t){this._center=this._projection.lngLatToPoint(new BMap.Point(t[0],t[1]))},o.prototype.setMapOffset=function(t){this._mapOffset=t},o.prototype.getBMap=function(){return this._bmap},o.prototype.dataToPoint=function(t){var e=new BMap.Point(t[0],t[1]),o=this._bmap.pointToOverlayPixel(e),n=this._mapOffset;return[o.x-n[0],o.y-n[1]]},o.prototype.pointToData=function(t){var e=this._mapOffset;return[(t=this._bmap.overlayPixelToPoint({x:t[0]+e[0],y:t[1]+e[1]})).lng,t.lat]},o.prototype.getViewRect=function(){var t=this._api;return new e.graphic.BoundingRect(0,0,t.getWidth(),t.getHeight())},o.prototype.getRoamTransform=function(){return e.matrix.create()},o.prototype.prepareCustoms=function(t){var o=this.getViewRect();return{coordSys:{type:"bmap",x:o.x,y:o.y,width:o.width,height:o.height},api:{coord:e.util.bind(this.dataToPoint,this),size:e.util.bind(n,this)}}},o.dimensions=o.prototype.dimensions,o.create=function(t,e){var n,i=e.getDom();t.eachComponent("bmap",(function(t){var a=e.getZr().painter,p=a.getViewportRoot();if("undefined"==typeof BMap)throw new Error("BMap api is not loaded");if(r=r||function(){function t(t){this._root=t}return t.prototype=new BMap.Overlay,t.prototype.initialize=function(t){return t.getPanes().labelPane.appendChild(this._root),this._root},t.prototype.draw=function(){},t}(),n)throw new Error("Only one bmap component can exist");if(!t.__bmap){var s=i.querySelector(".ec-extension-bmap");s&&(p.style.left="0px",p.style.top="0px",i.removeChild(s)),(s=document.createElement("div")).style.cssText="width:100%;height:100%",s.classList.add("ec-extension-bmap"),i.appendChild(s);var c=t.__bmap=new BMap.Map(s),m=new r(p);c.addOverlay(m),a.getViewportRootOffset=function(){return{offsetLeft:0,offsetTop:0}}}c=t.__bmap;var f=t.get("center"),l=t.get("zoom");if(f&&l){var d=new BMap.Point(f[0],f[1]);c.centerAndZoom(d,l)}(n=new o(c,e)).setMapOffset(t.__mapOffset||[0,0]),n.setZoom(l),n.setCenter(f),t.coordinateSystem=n})),t.eachSeries((function(t){"bmap"===t.get("coordinateSystem")&&(t.coordinateSystem=n)}))},e.extendComponentModel({type:"bmap",getBMap:function(){return this.__bmap},setCenterAndZoom:function(t,e){this.option.center=t,this.option.zoom=e},centerOrZoomChanged:function(t,e){var o,n,r=this.option;return o=t,n=r.center,!(o&&n&&o[0]===n[0]&&o[1]===n[1]&&e===r.zoom)},defaultOption:{center:[104.114129,37.550339],zoom:5,mapStyle:{},mapStyleV2:{},roam:!1}});var i={"[object Function]":1,"[object RegExp]":1,"[object Date]":1,"[object Error]":1,"[object CanvasGradient]":1,"[object CanvasPattern]":1,"[object Image]":1,"[object Canvas]":1},a={"[object Int8Array]":1,"[object Uint8Array]":1,"[object Uint8ClampedArray]":1,"[object Int16Array]":1,"[object Uint16Array]":1,"[object Int32Array]":1,"[object Uint32Array]":1,"[object Float32Array]":1,"[object Float64Array]":1},p=Object.prototype.toString;function s(t){if(null==t||"object"!=typeof t)return t;var e,o=t,n=p.call(t);if("[object Array]"===n){if(!c(t)){o=[];for(var r=0,m=t.length;r<m;r++)o[r]=s(t[r])}}else if(a[n]){if(!c(t)){var f=t.constructor;if(t.constructor.from)o=f.from(t);else{o=new f(t.length);for(r=0,m=t.length;r<m;r++)o[r]=s(t[r])}}}else if(!i[n]&&!c(t)&&("object"!=typeof(e=t)||"number"!=typeof e.nodeType||"object"!=typeof e.ownerDocument))for(var l in o={},t)t.hasOwnProperty(l)&&(o[l]=s(t[l]));return o}function c(t){return t.__ec_primitive__}e.extendComponentView({type:"bmap",render:function(t,e,o){var n=!0,r=t.getBMap(),i=o.getZr().painter.getViewportRoot(),a=t.coordinateSystem,p=function(e,r){if(!n){var p=i.parentNode.parentNode.parentNode,s=[-parseInt(p.style.left,10)||0,-parseInt(p.style.top,10)||0];i.style.left=s[0]+"px",i.style.top=s[1]+"px",a.setMapOffset(s),t.__mapOffset=s,o.dispatchAction({type:"bmapRoam"})}};function c(){n||o.dispatchAction({type:"bmapRoam"})}r.removeEventListener("moving",this._oldMoveHandler),r.removeEventListener("zoomend",this._oldZoomEndHandler),r.addEventListener("moving",p),r.addEventListener("zoomend",c),this._oldMoveHandler=p,this._oldZoomEndHandler=c;var m=t.get("roam");m&&"scale"!==m?r.enableDragging():r.disableDragging(),m&&"move"!==m?(r.enableScrollWheelZoom(),r.enableDoubleClickZoom(),r.enablePinchToZoom()):(r.disableScrollWheelZoom(),r.disableDoubleClickZoom(),r.disablePinchToZoom());var f=t.__mapStyle,l=t.get("mapStyle")||{},d=JSON.stringify(l);JSON.stringify(f)!==d&&(Object.keys(l).length&&r.setMapStyle(s(l)),t.__mapStyle=JSON.parse(d));var y=t.__mapStyle2,u=t.get("mapStyleV2")||{},h=JSON.stringify(u);JSON.stringify(y)!==h&&(Object.keys(u).length&&r.setMapStyleV2(s(u)),t.__mapStyle2=JSON.parse(h)),n=!1}}),e.registerCoordinateSystem("bmap",o),e.registerAction({type:"bmapRoam",event:"bmapRoam",update:"updateLayout"},(function(t,e){e.eachComponent("bmap",(function(t){var e=t.getBMap(),o=e.getCenter();t.setCenterAndZoom([o.lng,o.lat],e.getZoom())}))}));t.version="1.0.0",Object.defineProperty(t,"__esModule",{value:!0})}));
